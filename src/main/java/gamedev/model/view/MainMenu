package gamedev.model.view;

import gamedev.controller.GameController;
import gamedev.model.SoundPlayer;
import javafx.animation.FadeTransition;
import javafx.animation.ParallelTransition;
import javafx.animation.ScaleTransition;
import javafx.animation.TranslateTransition;
import javafx.geometry.Pos;
import javafx.scene.Cursor;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.effect.DropShadow;
import javafx.scene.effect.Glow;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.StackPane;
import javafx.scene.layout.VBox;
import javafx.stage.Screen;
import javafx.stage.Stage;
import javafx.util.Duration;

public class MainMenu {
    private Stage primaryStage;
    private double screenWidth;
    private double screenHeight;

    public MainMenu(Stage primaryStage) {
        this.primaryStage = primaryStage;

        // Отримуємо розміри екрану
        Screen screen = Screen.getPrimary();
        screenWidth = screen.getBounds().getWidth();
        screenHeight = screen.getBounds().getHeight();
    }

    public void show() {
        // Завантажуємо фон меню на весь екран
        Image backgroundImage = new Image(getClass().getResourceAsStream("/ui/menu_back1.png"));
        ImageView background = new ImageView(backgroundImage);
        background.setFitWidth(screenWidth);
        background.setFitHeight(screenHeight);

        // Створюємо кнопки з вашими зображеннями
        Button startButton = createImageButton("/ui/menu_play.png");
        Button settingsButton = createImageButton("/ui/menu_rules.png");
        Button exitButton = createImageButton("/ui/menu_logout.png");

        // Додаємо обробники подій
        startButton.setOnAction(e -> startGame());
        settingsButton.setOnAction(e -> showRules());
        exitButton.setOnAction(e -> primaryStage.close());

        // Контейнер для кнопок
        VBox buttonContainer = new VBox(30);
        buttonContainer.setAlignment(Pos.CENTER);
        buttonContainer.getChildren().addAll(startButton, settingsButton, exitButton);

        // Головний контейнер
        StackPane root = new StackPane();
        root.getChildren().addAll(background, buttonContainer);

        // Створюємо сцену на весь екран
        Scene scene = new Scene(root, screenWidth, screenHeight);

        // Додаємо кастомний курсор
        try {
            Image cursorImage = new Image(getClass().getResource("/ui/cursor.png").toExternalForm());
            javafx.scene.ImageCursor customCursor = new javafx.scene.ImageCursor(cursorImage, cursorImage.getWidth() / 2, cursorImage.getHeight() / 2);
            scene.setCursor(customCursor);
        } catch (Exception e) {
            System.err.println("Не вдалося завантажити кастомний курсор: " + e.getMessage());
        }

        primaryStage.setScene(scene);
        primaryStage.setTitle("Hidden Objects Game");
        primaryStage.setMaximized(true); // Розгортаємо на весь екран
        primaryStage.show();

        // Анімація появи меню
        playMenuAppearAnimation(buttonContainer);
    }

    private void showRules() {
        //SoundPlayer.play("button_clicked.mp3");

        // Завантажуємо фон для правил
        Image rulesBackgroundImage = new Image(getClass().getResourceAsStream("/ui/menu_rules_back.png"));
        ImageView rulesBackground = new ImageView(rulesBackgroundImage);
        rulesBackground.setFitWidth(screenWidth);
        rulesBackground.setFitHeight(screenHeight);

        // Створюємо кнопку назад
        Button backButton = createBackButton("/ui/menu_backbut.png");

        // Додаємо обробник подій для кнопки назад
        backButton.setOnAction(e -> showMainMenu());

        // Створюємо контейнер для правил
        StackPane rulesRoot = new StackPane();
        rulesRoot.getChildren().addAll(rulesBackground, backButton);

        // Оновлюємо сцену
        Scene rulesScene = new Scene(rulesRoot, screenWidth, screenHeight);

        // Додаємо кастомний курсор
        try {
            Image cursorImage = new Image(getClass().getResource("/ui/cursor.png").toExternalForm());
            javafx.scene.ImageCursor customCursor = new javafx.scene.ImageCursor(cursorImage, cursorImage.getWidth() / 2, cursorImage.getHeight() / 2);
            rulesScene.setCursor(customCursor);
        } catch (Exception e) {
            System.err.println("Не вдалося завантажити кастомний курсор: " + e.getMessage());
        }

        primaryStage.setScene(rulesScene);
    }

    private Button createBackButton(String imagePath) {
        try {
            // Завантажуємо зображення для кнопки назад
            Image buttonImage = new Image(getClass().getResourceAsStream(imagePath));
            ImageView imageView = new ImageView(buttonImage);

            // Налаштовуємо розмір кнопки назад
            imageView.setFitWidth(621);
            imageView.setFitHeight(200);

            // Створюємо кнопку
            Button button = new Button();
            button.setGraphic(imageView);
            button.setStyle("-fx-background-color: transparent; -fx-border-color: transparent;");

            // Налаштовуємо позицію кнопки (по центру екрана, висота -150)
            StackPane.setAlignment(button, Pos.BOTTOM_CENTER);
            button.setTranslateY(-150); // Висота -150 від низу

            // Налаштовуємо ефекти для кнопки
            setupButtonEffects(button, imageView);

            return button;

        } catch (Exception e) {
            System.err.println("Помилка завантаження зображення: " + imagePath);
            // Резервна текстова кнопка
            Button fallbackButton = new Button("Назад");
            fallbackButton.setStyle("-fx-font-size: 20px; -fx-padding: 10px 20px; -fx-background-color: #4CAF50; -fx-text-fill: white;");
            StackPane.setAlignment(fallbackButton, Pos.BOTTOM_CENTER);
            fallbackButton.setTranslateY(-150);
            setupTextButtonEffects(fallbackButton);
            return fallbackButton;
        }
    }

    private void showMainMenu() {
        SoundPlayer.play("button_clicked.mp3");
        show(); // Просто повторно викликаємо метод show() для повернення в головне меню
    }

    private Button createImageButton(String imagePath) {
        try {
            // Завантажуємо зображення для кнопки
            Image buttonImage = new Image(getClass().getResourceAsStream(imagePath));
            ImageView imageView = new ImageView(buttonImage);

            // Збільшуємо розмір кнопок для великого екрану
            imageView.setFitWidth(621);
            imageView.setFitHeight(200);

            // Створюємо кнопку
            Button button = new Button();
            button.setGraphic(imageView);

            // Робимо прозорий фон та рамку
            button.setStyle("-fx-background-color: transparent; -fx-border-color: transparent;");

            // Налаштовуємо ефекти для кнопки
            setupButtonEffects(button, imageView);

            return button;

        } catch (Exception e) {
            System.err.println("Помилка завантаження зображення: " + imagePath);
            // Якщо зображення не знайдено, створити текстову кнопку
            Button fallbackButton = new Button("Кнопка");
            fallbackButton.setStyle("-fx-font-size: 24px; -fx-padding: 15px 30px; -fx-background-color: #4CAF50; -fx-text-fill: white;");
            setupTextButtonEffects(fallbackButton);
            return fallbackButton;
        }
    }

    private void setupButtonEffects(Button button, ImageView imageView) {
        // Ефект тіні
        DropShadow shadow = new DropShadow();
        shadow.setColor(javafx.scene.paint.Color.rgb(0, 0, 0, 0.4));
        shadow.setRadius(15);
        shadow.setSpread(0.15);
        shadow.setOffsetX(0);
        shadow.setOffsetY(6);

        // Ефект світіння
        Glow glow = new Glow();
        glow.setLevel(0.3);

        // Анімації
        ScaleTransition scaleTransition = new ScaleTransition(Duration.millis(150), imageView);
        scaleTransition.setFromX(1.0);
        scaleTransition.setFromY(1.0);
        scaleTransition.setToX(1.1);
        scaleTransition.setToY(1.1);

        TranslateTransition liftTransition = new TranslateTransition(Duration.millis(150), imageView);
        liftTransition.setToY(-5);

        button.setCursor(Cursor.HAND);

        // Наведення миші
        button.setOnMouseEntered(e -> {
            button.setEffect(shadow);
            scaleTransition.playFromStart();
            liftTransition.playFromStart();
            imageView.setEffect(glow);
        });

        // Подія коли миша йде
        button.setOnMouseExited(e -> {
            scaleTransition.stop();
            liftTransition.stop();
            imageView.setScaleX(1.0);
            imageView.setScaleY(1.0);
            imageView.setTranslateY(0);
            imageView.setTranslateX(0);
            button.setEffect(null);
            imageView.setEffect(null);
        });

        // Подія натискання
        button.setOnMousePressed(e -> {
            SoundPlayer.play("button_clicked.mp3"); // Звук кліку
            imageView.setScaleX(0.95);
            imageView.setScaleY(0.95);
            imageView.setTranslateY(2);
        });

        button.setOnMouseReleased(e -> {
            imageView.setScaleX(1.0);
            imageView.setScaleY(1.0);
            imageView.setTranslateY(-5);
        });
    }

    private void setupTextButtonEffects(Button button) {
        DropShadow shadow = new DropShadow();
        shadow.setColor(javafx.scene.paint.Color.rgb(0, 0, 0, 0.4));
        shadow.setRadius(10);
        shadow.setOffsetY(4);

        ScaleTransition scaleTransition = new ScaleTransition(Duration.millis(150), button);
        scaleTransition.setFromX(1.0);
        scaleTransition.setFromY(1.0);
        scaleTransition.setToX(1.05);
        scaleTransition.setToY(1.05);

        button.setCursor(Cursor.HAND);

        button.setOnMouseEntered(e -> {
            SoundPlayer.play("button_clicked.mp3");
            button.setEffect(shadow);
            scaleTransition.playFromStart();
            button.setStyle("-fx-font-size: 24px; -fx-padding: 15px 30px; -fx-background-color: #45a049; -fx-text-fill: white;");
        });

        button.setOnMouseExited(e -> {
            scaleTransition.stop();
            button.setScaleX(1.0);
            button.setScaleY(1.0);
            button.setEffect(null);
            button.setStyle("-fx-font-size: 24px; -fx-padding: 15px 30px; -fx-background-color: #4CAF50; -fx-text-fill: white;");
        });

        button.setOnMousePressed(e -> {
            SoundPlayer.play("button_clicked.mp3");
            button.setScaleX(0.95);
            button.setScaleY(0.95);
        });

        button.setOnMouseReleased(e -> {
            button.setScaleX(1.05);
            button.setScaleY(1.05);
        });
    }

    private void playMenuAppearAnimation(VBox buttonContainer) {
        // Анімація появи кнопок
        for (int i = 0; i < buttonContainer.getChildren().size(); i++) {
            Button button = (Button) buttonContainer.getChildren().get(i);
            button.setOpacity(0);
            button.setTranslateY(50);

            FadeTransition fadeIn = new FadeTransition(Duration.millis(500), button);
            fadeIn.setFromValue(0);
            fadeIn.setToValue(1);
            fadeIn.setDelay(Duration.millis(i * 150));

            TranslateTransition slideUp = new TranslateTransition(Duration.millis(500), button);
            slideUp.setFromY(50);
            slideUp.setToY(0);
            slideUp.setDelay(Duration.millis(i * 150));

            ParallelTransition parallelTransition = new ParallelTransition(fadeIn, slideUp);
            parallelTransition.play();
        }
    }

    private void startGame() {
        playTransitionAnimation(() -> {
            Game game = new Game(Collections.emptyList()); // создаём игру без уровней
            GameController controller = new GameController(game); // передаём игру в контроллер
            GameView view = new GameView(controller, primaryStage); // создаём View с контроллером и Stage
            controller.setView(view); // связываем контроллер с View
            controller.startGame(primaryStage); // запускаем игру
        });
    }

    private void playTransitionAnimation(Runnable onComplete) {
        // Анімація зникнення меню перед переходом
        FadeTransition fadeOut = new FadeTransition(Duration.millis(300), primaryStage.getScene().getRoot());
        fadeOut.setFromValue(1.0);
        fadeOut.setToValue(0.0);
        fadeOut.setOnFinished(e -> onComplete.run());
        fadeOut.play();
    }
}